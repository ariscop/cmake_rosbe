From 00322a8437341d06184cc11fd9fb022d34bf9619 Mon Sep 17 00:00:00 2001
From: Amine Khaldi <amine.khaldi@reactos.org>
Date: Sun, 22 Mar 2015 16:45:28 +0100
Subject: [PATCH 7/7] Don't let CMake handle CharacterSet. Same for
 PrecompiledHeader, SubSystem, ImportLibrary, RandomizedBaseAddress,
 DataExecutionPrevention and EnableUAC. We handle these on our own.

---
 Source/cmVisualStudio10TargetGenerator.cxx | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/Source/cmVisualStudio10TargetGenerator.cxx b/Source/cmVisualStudio10TargetGenerator.cxx
index 0679a2a8a..a308d09b0 100644
--- a/Source/cmVisualStudio10TargetGenerator.cxx
+++ b/Source/cmVisualStudio10TargetGenerator.cxx
@@ -763,6 +763,8 @@ void cmVisualStudio10TargetGenerator
     {
     this->WriteString("<CharacterSet>Unicode</CharacterSet>\n", 2);
     }
+  else this->WriteString("<CharacterSet>NotSet</CharacterSet>\n", 2);
+#if 0
   else if (this->Target->GetType() <= cmTarget::MODULE_LIBRARY &&
            this->ClOptions[config]->UsingSBCS())
     {
@@ -772,6 +774,7 @@ void cmVisualStudio10TargetGenerator
     {
     this->WriteString("<CharacterSet>MultiByte</CharacterSet>\n", 2);
     }
+#endif
   if(const char* toolset = gg->GetPlatformToolset())
     {
     std::string pts = "<PlatformToolset>";
@@ -1948,7 +1951,10 @@ bool cmVisualStudio10TargetGenerator::ComputeClOptions(
   if(this->MSTools)
     {
     clOptions.FixExceptionHandlingDefault();
+    clOptions.AddFlag("RuntimeLibrary", "");
+#if 0
     clOptions.AddFlag("PrecompiledHeader", "NotUsing");
+#endif
     std::string asmLocation = configName + "/";
     clOptions.AddFlag("AssemblerListingLocation", asmLocation.c_str());
     }
@@ -2553,10 +2559,12 @@ cmVisualStudio10TargetGenerator::ComputeLinkOptions(std::string const& config)
             }
           }
         }
+#if 0
       else
         {
         linkOptions.AddFlag("SubSystem", "Windows");
         }
+#endif
       }
     else
       {
@@ -2575,10 +2583,12 @@ cmVisualStudio10TargetGenerator::ComputeLinkOptions(std::string const& config)
             }
           }
         }
+#if 0
       else
         {
         linkOptions.AddFlag("SubSystem", "Console");
         };
+#endif
       }
 
     if(const char* stackVal =
@@ -2614,12 +2624,16 @@ cmVisualStudio10TargetGenerator::ComputeLinkOptions(std::string const& config)
     std::string pdb = this->Target->GetPDBDirectory(config.c_str());
     pdb += "/";
     pdb += targetNamePDB;
+#if 0
     std::string imLib = this->Target->GetDirectory(config.c_str(), true);
     imLib += "/";
     imLib += targetNameImport;
 
     linkOptions.AddFlag("ImportLibrary", imLib.c_str());
+#endif
     linkOptions.AddFlag("ProgramDataBaseFile", pdb.c_str());
+    linkOptions.AddFlag("RandomizedBaseAddress", "");
+    linkOptions.AddFlag("DataExecutionPrevention", "");
 
     // A Windows Runtime component uses internal .NET metadata,
     // so does not have an import library.
@@ -2688,6 +2702,7 @@ cmVisualStudio10TargetGenerator::WriteLinkOptions(std::string const& config)
   this->WriteString("<Link>\n", 2);
 
   linkOptions.OutputAdditionalOptions(*this->BuildFileStream, "      ", "");
+  linkOptions.AddFlag("EnableUAC", "");
   linkOptions.OutputFlagMap(*this->BuildFileStream, "      ");
 
   this->WriteString("</Link>\n", 2);
-- 
2.17.1

