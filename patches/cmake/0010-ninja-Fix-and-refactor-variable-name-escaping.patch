From 68c3888db04238b15b99f2263ca746662eaf385b Mon Sep 17 00:00:00 2001
From: Ben Boeckel <ben.boeckel@kitware.com>
Date: Thu, 1 May 2014 15:46:50 -0400
Subject: [PATCH 10/17] ninja: Fix and refactor variable name escaping

This work is based on Ben Boeckel's experiments in https://github.com/mathstuf/CMake/commits/dev/output-target-flags-once-in-ninja
---
 Source/cmNinjaTargetGenerator.cxx | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/Source/cmNinjaTargetGenerator.cxx b/Source/cmNinjaTargetGenerator.cxx
index b31cc1df7..49298c18e 100644
--- a/Source/cmNinjaTargetGenerator.cxx
+++ b/Source/cmNinjaTargetGenerator.cxx
@@ -121,6 +121,16 @@ void cmNinjaTargetGenerator::AddFeatureFlags(std::string& flags,
     }
 }
 
+static void EscapeTargetForVariable(std::string& name)
+{
+  // '.' is not allowed in variable names, so escape them.
+  cmSystemTools::ReplaceString(name, "dot", "dotdot");
+  cmSystemTools::ReplaceString(name, ".", "ldot");
+  // '+' is not allowed in variable names, so escape them.
+  cmSystemTools::ReplaceString(name, "plus", "plusplus");
+  cmSystemTools::ReplaceString(name, "+", "lplus");
+}
+
 std::string
 cmNinjaTargetGenerator::OrderDependsTargetForTarget()
 {
@@ -131,9 +141,7 @@ std::string
 cmNinjaTargetGenerator::FlagVariableForTarget(std::string const& lang)
 {
   std::string targetName = this->GetTargetName();
-  // '.' is not allowed in variable names, so escape them.
-  cmSystemTools::ReplaceString(targetName, "dot", "dotdot_");
-  cmSystemTools::ReplaceString(targetName, ".", "dot_");
+  EscapeTargetForVariable(targetName);
   return "cmake_flags_target_" + targetName + "_lang_" + lang;
 }
 
@@ -141,9 +149,7 @@ std::string
 cmNinjaTargetGenerator::DefineVariableForTarget(std::string const& lang)
 {
   std::string targetName = this->GetTargetName();
-  // '.' is not allowed in variable names, so escape them.
-  cmSystemTools::ReplaceString(targetName, "dot", "dotdot_");
-  cmSystemTools::ReplaceString(targetName, ".", "dot_");
+  EscapeTargetForVariable(targetName);
   return "cmake_defines_target_" + targetName + "_lang_" + lang;
 }
 
-- 
2.17.1

